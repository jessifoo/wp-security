<?php
/**
 * Tests for the Obfuscated_Malware_Scanner class.
 *
 * @package ObfuscatedMalwareScanner
 */

use PHPUnit\Framework\TestCase;

require_once __DIR__ . '/WordPressMocksTrait.php';
require_once __DIR__ . '/TestHelperTrait.php';

/**
 * Test case for Obfuscated_Malware_Scanner.
 */
class ObfuscatedMalwareScannerTest extends TestCase {

	use WordPressMocksTrait;
	use TestHelperTrait;

	private Obfuscated_Malware_Scanner $scanner;
	private OMS_Logger $logger;
	private OMS_Cache $cache;
	private OMS_Rate_Limiter $rate_limiter;
	private OMS_Filesystem $filesystem;
	private OMS_File_Security_Policy $security_policy;
	private OMS_Quarantine_Manager $quarantine_manager;
	private OMS_Core_Integrity_Checker $integrity_checker;
	private OMS_Database_Scanner $database_scanner;

	protected function setUp(): void {
		parent::setUp();

		// Set up test environment.
		$this->createTemporaryDirectory();
		$this->mockWordPressEnvironment();

		// Create mock dependencies.
		$this->logger             = $this->createMock( OMS_Logger::class );
		$this->cache              = $this->createMock( OMS_Cache::class );
		$this->rate_limiter       = $this->createMock( OMS_Rate_Limiter::class );
		$this->filesystem         = $this->createMock( OMS_Filesystem::class );
		$this->security_policy    = $this->createMock( OMS_File_Security_Policy::class );
		$this->quarantine_manager = $this->createMock( OMS_Quarantine_Manager::class );
		$this->integrity_checker  = $this->createMock( OMS_Core_Integrity_Checker::class );
		$this->database_scanner   = $this->createMock( OMS_Database_Scanner::class );

		// Default rate limiter behavior.
		$this->rate_limiter->method( 'should_throttle' )->willReturn( false );

		// Default security policy behavior.
		$this->security_policy->method( 'validate_file' )->willReturn(
			array(
				'valid'  => true,
				'reason' => 'Clean file',
			)
		);

		// Create scanner with mocked dependencies.
		$this->scanner = new Obfuscated_Malware_Scanner(
			$this->logger,
			$this->cache,
			$this->rate_limiter,
			$this->filesystem,
			$this->security_policy,
			$this->quarantine_manager,
			$this->integrity_checker,
			$this->database_scanner
		);
	}

	protected function tearDown(): void {
		$this->cleanupTestEnvironment();
		parent::tearDown();
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::check_uploaded_file
	 */
	public function testCheckUploadedFileWithMaliciousContent() {
		// Create test file with malicious content.
		$test_file = $this->createTestFile(
			'malicious.php',
			'<?php eval(base64_decode("malicious_code")); ?>'
		);

		// Mock upload dir to point to test file location.
		$this->mockWPUploadDir( dirname( $test_file ) );

		// Policy says file is invalid.
		$this->security_policy = $this->createMock( OMS_File_Security_Policy::class );
		$this->security_policy->method( 'validate_file' )->willReturn(
			array(
				'valid'  => false,
				'reason' => 'PHP files not allowed',
			)
		);

		// Recreate scanner with strict policy.
		$scanner = new Obfuscated_Malware_Scanner(
			$this->logger,
			$this->cache,
			$this->rate_limiter,
			$this->filesystem,
			$this->security_policy,
			$this->quarantine_manager,
			$this->integrity_checker,
			$this->database_scanner
		);

		// Expect quarantine to be called.
		$this->quarantine_manager->expects( $this->once() )
			->method( 'quarantine_file' )
			->willReturn( true );

		// Test file check.
		$scanner->check_uploaded_file( 1, 1, '_wp_attached_file', basename( $test_file ) );

		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::check_uploaded_file
	 */
	public function testCheckUploadedFileWithCleanContent() {
		// Create test file with clean content.
		$test_file = $this->createTestFile( 'clean.txt', 'This is clean content' );

		// Mock upload dir.
		$this->mockWPUploadDir( dirname( $test_file ) );

		// Policy says file is valid.
		$this->security_policy->method( 'validate_file' )->willReturn(
			array(
				'valid'  => true,
				'reason' => 'Clean file',
			)
		);

		// Expect quarantine NOT to be called.
		$this->quarantine_manager->expects( $this->never() )
			->method( 'quarantine_file' );

		// Test file check.
		$this->scanner->check_uploaded_file( 1, 1, '_wp_attached_file', basename( $test_file ) );

		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::check_uploaded_file
	 */
	public function testCheckUploadedFileIgnoresOtherMetaKeys() {
		// Should not process non-attachment meta.
		$this->quarantine_manager->expects( $this->never() )
			->method( 'quarantine_file' );

		$this->scanner->check_uploaded_file( 1, 1, '_other_meta_key', 'file.php' );

		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::contains_malware
	 */
	public function testContainsMalwareWithUnreadableFile() {
		// Create unreadable test file.
		$test_file = $this->createTestFile(
			'unreadable.php',
			'<?php echo "test"; ?>',
			0200 // Write-only.
		);

		// Expect warning to be logged.
		$this->logger->expects( $this->once() )
			->method( 'warning' )
			->with( $this->stringContains( 'not accessible' ) );

		$result = $this->scanner->contains_malware( $test_file );

		$this->assertTrue( $result, 'Unreadable files should be treated as suspicious' );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::contains_malware
	 */
	public function testContainsMalwareWithBrokenSymlink() {
		// Create broken symlink.
		$broken_symlink = $this->createTestSymlink( 'nonexistent.php', 'broken.php', true );

		// Expect warning to be logged.
		$this->logger->expects( $this->once() )
			->method( 'warning' )
			->with( $this->stringContains( 'not accessible' ) );

		$result = $this->scanner->contains_malware( $broken_symlink );

		$this->assertTrue( $result, 'Broken symlinks should be treated as suspicious' );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::contains_malware
	 */
	public function testContainsMalwareWithCleanFile() {
		// Create clean test file.
		$test_file = $this->createTestFile( 'clean.txt', 'This is completely safe content' );

		$result = $this->scanner->contains_malware( $test_file );

		$this->assertFalse( $result, 'Clean files should not be flagged as malware' );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::quarantine_file
	 */
	public function testQuarantineFileDelegatesToManager() {
		$test_file = $this->createTestFile( 'suspicious.php', '<?php eval($code); ?>' );

		$this->quarantine_manager->expects( $this->once() )
			->method( 'quarantine_file' )
			->with( $test_file )
			->willReturn( true );

		$result = $this->scanner->quarantine_file( $test_file );

		$this->assertTrue( $result );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::get_status
	 */
	public function testGetStatusReturnsExpectedStructure() {
		$status = $this->scanner->get_status();

		$this->assertIsArray( $status );
		$this->assertArrayHasKey( 'last_scan', $status );
		$this->assertArrayHasKey( 'files_scanned', $status );
		$this->assertArrayHasKey( 'issues_found', $status );
		$this->assertArrayHasKey( 'issues', $status );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::scan_database
	 */
	public function testScanDatabaseDelegatesToScanner() {
		$expected_result = array(
			'success' => true,
			'total'   => 0,
			'issues'  => array(),
		);

		$this->database_scanner->expects( $this->once() )
			->method( 'scan_database' )
			->willReturn( $expected_result );

		$result = $this->scanner->scan_database();

		$this->assertEquals( $expected_result, $result );
	}

	/**
	 * @test
	 * @covers Obfuscated_Malware_Scanner::sanitize_upload_path
	 */
	public function testSanitizeUploadPathPreservesValidPaths() {
		$upload_dir = array(
			'path'    => '/var/www/html/wp-content/uploads/2024/01',
			'basedir' => '/var/www/html/wp-content/uploads',
			'error'   => false,
		);

		$result = $this->scanner->sanitize_upload_path( $upload_dir );

		$this->assertFalse( $result['error'] ?? true );
		$this->assertArrayHasKey( 'path', $result );
	}
}
