<?php

use PHPUnit\Framework\TestCase;

require_once dirname( __DIR__ ) . '/includes/class-oms-error-handler.php';
require_once dirname( __DIR__ ) . '/includes/class-oms-quarantine-manager.php';
require_once dirname( __DIR__ ) . '/includes/class-oms-filesystem.php';
require_once dirname( __DIR__ ) . '/includes/class-oms-core-integrity-checker.php';
require_once dirname( __DIR__ ) . '/includes/class-obfuscated-malware-scanner.php';
require_once __DIR__ . '/WordPressMocksTrait.php';
require_once __DIR__ . '/TestHelperTrait.php';

// Mock classes for testing
// Mock classes for testing
// OMS_Cache and OMS_Rate_Limiter are now loaded from source

#[AllowDynamicProperties]
class TestableObfuscatedMalwareScanner extends Obfuscated_Malware_Scanner {
	public function __construct() {
		parent::__construct();
	}

	/**
	 * Helper to access private methods for testing.
	 *
	 * @param string $method Method name.
	 * @param array  $args   Method arguments.
	 * @return mixed Method return value.
	 */
	public function callPrivateMethod( $method, $args = array() ) {
		$reflection = new ReflectionClass( $this );
		$method     = $reflection->getMethod( $method );
		$method->setAccessible( true );
		return $method->invokeArgs( $this, $args );
	}

	public function contains_malware( string $path ): bool {
		return parent::contains_malware( $path );
	}

	public function calculate_optimal_chunk_size( int $filesize = 0 ): int {
		return parent::calculate_optimal_chunk_size( $filesize );
	}

	public function set_plugin_dir( $dir ) {
		$reflection = new ReflectionClass( Obfuscated_Malware_Scanner::class );
		$property   = $reflection->getProperty( 'plugin_dir' );
		$property->setAccessible( true );
		$property->setValue( $this, $dir );
	}

	public function set_theme_dir( $dir ) {
		$reflection = new ReflectionClass( Obfuscated_Malware_Scanner::class );
		$property   = $reflection->getProperty( 'theme_dir' );
		$property->setAccessible( true );
		$property->setValue( $this, $dir );
	}

	public function set_uploads_dir( $dir ) {
		$reflection = new ReflectionClass( Obfuscated_Malware_Scanner::class );
		$property   = $reflection->getProperty( 'uploads_dir' );
		$property->setAccessible( true );
		$property->setValue( $this, $dir );
	}
}

class ObfuscatedMalwareScannerTest extends TestCase {

	use WordPressMocksTrait;
	use TestHelperTrait;

	private $scanner;
	private $logger;

	protected function setUp(): void {
		parent::setUp();

		// Set up test environment
		$this->createTemporaryDirectory();
		$this->logger = $this->createMockLogger();
		$this->mockWordPressEnvironment();

		// Create scanner instance
		$this->scanner = $this->getMockBuilder( TestableObfuscatedMalwareScanner::class )
			->onlyMethods( array( 'contains_malware' ) )
			->getMock();

		// Default scanner behavior
		$this->scanner->method( 'contains_malware' )->willReturn( false );

		$this->scanner->set_logger( $this->logger );
	}

	protected function tearDown(): void {
		$this->cleanupTestEnvironment();
		parent::tearDown();
	}

	/**
	 * @test
	 * @covers ::check_uploaded_file
	 */
	public function testCheckUploadedFileWithMaliciousContent() {
		// Create test file with malicious content
		$test_file = $this->createTestFile(
			'malicious.php',
			'<?php eval(base64_decode("malicious_code")); ?>'
		);

		// Mock upload dir to point to test file location
		$this->mockWPUploadDir( dirname( $test_file ) );

		// Set up mock expectations for malicious content
		$this->scanner->method( 'contains_malware' )->willReturn( true );

		// Test file check - malicious files should be quarantined
		$this->scanner->check_uploaded_file( 1, 1, '_wp_attached_file', basename( $test_file ) );

		// Verify quarantine happened (mocking quarantine would be better, but for now check if file exists)
		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers ::check_uploaded_file
	 */
	public function testCheckUploadedFileWithCleanContent() {
		// Create test file with clean content
		$test_file = $this->createTestFile( 'clean.txt', 'This is clean content' );

		// Set up scanner with mocked policy
		$policy = $this->createMockSecurityPolicy( true, 'Test file' );
		$this->scanner->set_security_policy( $policy );

		// Test file check - clean files should be allowed
		$this->scanner->check_uploaded_file( 1, 1, '_wp_attached_file', basename( $test_file ) );
		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers ::check_uploaded_file
	 */
	public function testCheckUploadedFileWithMaliciousContentWithPolicy() {
		// Create test file with malicious content
		$test_file = $this->createTestFile(
			'malicious.php',
			'<?php eval(base64_decode("malicious_code")); ?>'
		);

		// Set up scanner with mocked policy
		$policy = $this->createMockSecurityPolicy( false, 'PHP files not allowed' );
		$this->scanner->set_security_policy( $policy );
		$this->scanner->method( 'contains_malware' )->willReturn( true );

		// Test file check
		$this->scanner->check_uploaded_file( 1, 1, '_wp_attached_file', basename( $test_file ) );
		$this->assertTrue( true );
	}

	/**
	 * @test
	 * @covers ::contains_malware
	 */
	public function testSymlinkHandling() {
		// Create target file and symlinks
		$target_file    = $this->createTestFile( 'target.php', '<?php echo "test"; ?>' );
		$symlink_file   = $this->createTestSymlink( 'target.php', 'symlink.php' );
		$broken_symlink = $this->createTestSymlink( 'nonexistent.php', 'broken.php', true );

		// Set up logger expectations
		$logger = $this->createMockLogger(
			array(
				'warning' => $this->once(),
			)
		);

		// Test scanner with mocked logger
		$scanner = new TestableObfuscatedMalwareScanner();
		$scanner->set_logger( $logger );

		// Create valid symlink to benign file
		$target_file  = $this->createTestFile( 'target.txt', 'Safe text content' );
		$symlink_file = $this->createTestSymlink( 'target.txt', 'valid_link.txt' );

		// Test broken symlink
		$result = $scanner->contains_malware( $broken_symlink );
		$this->assertTrue( $result, 'Broken symlinks should be treated as suspicious' );

		// Test valid symlink
		$result = $scanner->contains_malware( $symlink_file );
		$this->assertFalse( $result, 'Valid symlinks should be scanned normally' );
	}

	/**
	 * @test
	 * @covers ::contains_malware
	 */
	public function testUnreadableFileHandling() {
		// Create unreadable test file
		$test_file = $this->createTestFile(
			'unreadable.php',
			'<?php echo "test"; ?>',
			0200 // Write-only
		);

		// Set up logger expectations
		$logger = $this->createMockLogger(
			array(
				'warning' => $this->once(),
			)
		);

		// Test scanner with mocked logger
		$scanner = new TestableObfuscatedMalwareScanner();
		$scanner->set_logger( $logger );

		$result = $scanner->contains_malware( $test_file );
		$this->assertTrue( $result, 'Unreadable files should be treated as suspicious' );
	}

	/**
	 * @test
	 * @covers ::cleanup_plugins
	 */
	public function testCleanupPlugins() {
		// Setup plugin directory
		$plugin_dir = $this->tempDir . '/wp-content/plugins';
		if ( ! file_exists( $plugin_dir ) ) {
			mkdir( $plugin_dir, 0777, true );
		}

		// Create a malicious file in the plugin
		$malicious_file = $plugin_dir . '/my-plugin/malware.php';
		if ( ! file_exists( dirname( $malicious_file ) ) ) {
			mkdir( dirname( $malicious_file ), 0777, true );
		}
		file_put_contents( $malicious_file, '<?php eval(base64_decode("...")); ?>' );

		// Mock scanner with validate_file expectation
		$scanner = $this->getMockBuilder( TestableObfuscatedMalwareScanner::class )
			->onlyMethods( array( 'validate_file', 'quarantine_file' ) )
			->getMock();

		$scanner->set_logger( $this->logger );
		$scanner->set_plugin_dir( $plugin_dir );

		$scanner->expects( $this->atLeastOnce() )
			->method( 'validate_file' )
			->willReturn(
				array(
					'valid'  => false,
					'reason' => 'Malware detected',
				)
			);

		$scanner->expects( $this->once() )
			->method( 'quarantine_file' )
			->with( $this->stringContains( 'malware.php' ) );

		$scanner->cleanup_plugins();
	}

	/**
	 * @test
	 * @covers ::cleanup_themes
	 */
	public function testCleanupThemes() {
		// Setup theme directory
		$theme_dir = $this->tempDir . '/wp-content/themes';
		if ( ! file_exists( $theme_dir ) ) {
			mkdir( $theme_dir, 0777, true );
		}

		// Create a malicious file in the theme
		$malicious_file = $theme_dir . '/my-theme/malware.php';
		if ( ! file_exists( dirname( $malicious_file ) ) ) {
			mkdir( dirname( $malicious_file ), 0777, true );
		}
		file_put_contents( $malicious_file, '<?php eval(base64_decode("...")); ?>' );

		// Mock scanner with validate_file expectation
		$scanner = $this->getMockBuilder( TestableObfuscatedMalwareScanner::class )
			->onlyMethods( array( 'validate_file', 'quarantine_file' ) )
			->getMock();

		$scanner->set_logger( $this->logger );
		$scanner->set_theme_dir( $theme_dir );

		$scanner->expects( $this->atLeastOnce() )
			->method( 'validate_file' )
			->willReturn(
				array(
					'valid'  => false,
					'reason' => 'Malware detected',
				)
			);

		$scanner->expects( $this->once() )
			->method( 'quarantine_file' )
			->with( $this->stringContains( 'malware.php' ) );

		$scanner->cleanup_themes();
	}

	/**
	 * @test
	 * @covers ::cleanup_uploads
	 */
	public function testCleanupUploads() {
		// Setup uploads directory
		$uploads_dir = $this->tempDir . '/wp-content/uploads';
		if ( ! file_exists( $uploads_dir ) ) {
			mkdir( $uploads_dir, 0777, true );
		}

		// Create a malicious file in uploads
		$malicious_file = $uploads_dir . '/malware.php';
		file_put_contents( $malicious_file, '<?php eval(base64_decode("...")); ?>' );

		// Mock scanner with validate_file expectation
		$scanner = $this->getMockBuilder( TestableObfuscatedMalwareScanner::class )
			->onlyMethods( array( 'validate_file', 'quarantine_file' ) )
			->getMock();

		$scanner->set_logger( $this->logger );
		$scanner->set_uploads_dir( $uploads_dir );

		$scanner->expects( $this->atLeastOnce() )
			->method( 'validate_file' )
			->willReturn(
				array(
					'valid'  => false,
					'reason' => 'Malware detected',
				)
			);

		$scanner->expects( $this->once() )
			->method( 'quarantine_file' )
			->with( $this->stringContains( 'malware.php' ) );

		$scanner->cleanup_uploads();
	}
}
