<?php
/**
 * Plugin Name: Obfuscated Malware Scanner
 * Description: Real-time malware prevention, detection, and cleanup for WordPress.
 * Version: 2.0.0
 * Author: Your Name
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: obfuscated-malware-scanner
 * Requires at least: 6.5
 * Requires PHP: 8.4
 *
 * @package ObfuscatedMalwareScanner
 */

// Prevent direct access.
if ( ! defined( 'ABSPATH' ) ) {
	exit( 'Direct access not allowed.' );
}

// =============================================================================
// Constants
// =============================================================================

define( 'OMS_VERSION', '2.0.0' );
define( 'OMS_PLUGIN_FILE', __FILE__ );
define( 'OMS_PLUGIN_DIR', plugin_dir_path( __FILE__ ) );
define( 'OMS_PLUGIN_URL', plugin_dir_url( __FILE__ ) );
define( 'OMS_PLUGIN_BASENAME', plugin_basename( __FILE__ ) );

// =============================================================================
// Autoloader
// =============================================================================

/**
 * Load plugin classes.
 *
 * Using require_once for explicit loading order.
 * For larger plugins, consider Composer autoload.
 */
function oms_load_classes(): void {
	$includes = OMS_PLUGIN_DIR . 'includes/';
	$admin    = OMS_PLUGIN_DIR . 'admin/';

	// Core classes (load order matters).
	require_once $includes . 'class-oms-exception.php';
	require_once $includes . 'class-oms-config.php';
	require_once $includes . 'class-oms-cache.php';
	require_once $includes . 'class-oms-logger.php';
	require_once $includes . 'class-oms-rate-limiter.php';
	require_once $includes . 'class-oms-utils.php';
	require_once $includes . 'class-oms-filesystem.php';
	require_once $includes . 'class-oms-file-security-policy.php';
	require_once $includes . 'class-oms-database-cleaner.php';
	require_once $includes . 'class-oms-database-scanner.php';
	require_once $includes . 'class-oms-core-integrity-checker.php';
	require_once $includes . 'class-oms-quarantine-manager.php';
	require_once $includes . 'class-oms-api.php';
	require_once $includes . 'class-obfuscated-malware-scanner.php';
	require_once $includes . 'class-oms-container.php';
	require_once $includes . 'class-oms-plugin.php';

	// Admin classes.
	require_once $admin . 'class-oms-admin.php';
}

// =============================================================================
// Activation & Deactivation Hooks (MUST be at top level)
// =============================================================================

/**
 * Plugin activation callback.
 *
 * Registered at top level BEFORE any other code runs.
 *
 * @return void
 */
function oms_activate(): void {
	oms_load_classes();
	OMS_Plugin::activate();
}

/**
 * Plugin deactivation callback.
 *
 * @return void
 */
function oms_deactivate(): void {
	oms_load_classes();
	OMS_Plugin::deactivate();
}

// Register hooks at TOP LEVEL (critical for WordPress).
register_activation_hook( __FILE__, 'oms_activate' );
register_deactivation_hook( __FILE__, 'oms_deactivate' );

// =============================================================================
// Plugin Initialization
// =============================================================================

/**
 * Initialize the plugin.
 *
 * Called on 'plugins_loaded' hook to ensure all dependencies are available.
 *
 * @return void
 */
function oms_init(): void {
	// Load text domain for translations.
	load_plugin_textdomain(
		'obfuscated-malware-scanner',
		false,
		dirname( OMS_PLUGIN_BASENAME ) . '/languages/'
	);

	// Boot the service container.
	OMS_Container::boot();

	// Get the scanner and register its hooks.
	$scanner = OMS_Container::get( Obfuscated_Malware_Scanner::class );
	$scanner->register_hooks();

	// Initialize REST API.
	$api = OMS_Container::get( OMS_API::class );
	$api->init();

	// Initialize admin interface.
	if ( is_admin() ) {
		$admin = OMS_Container::get( OMS_Admin::class );
		$admin->init();
	}
}

/**
 * Bootstrap the plugin.
 *
 * @return void
 */
function oms_bootstrap(): void {
	// Load classes first.
	oms_load_classes();

	// Initialize on plugins_loaded for proper hook timing.
	add_action( 'plugins_loaded', 'oms_init' );
}

// Allow tests to skip initialization.
if ( ! defined( 'OMS_SKIP_INIT' ) || ! OMS_SKIP_INIT ) {
	oms_bootstrap();
}
