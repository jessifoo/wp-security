<?php
/**
 * Plugin Name: Obfuscated Malware Scanner
 * Description: A WordPress plugin for real-time malware prevention and cleanup.
 * Version: 1.0.0
 * Author: Your Name
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: obfuscated-malware-scanner
 * Requires at least: 6.4
 * Requires PHP: 8.2
 *
 * @package ObfuscatedMalwareScanner
 */

// If this file is called directly, abort.
if ( ! defined( 'ABSPATH' ) ) {
	die( 'Direct access is not allowed.' );
}

// Define plugin constants.
// phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedConstantFound -- Plugin constants are acceptable without prefix.
define( 'OMS_VERSION', '1.0.0' );
// phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedConstantFound -- Plugin constants are acceptable without prefix.
define( 'OMS_PLUGIN_DIR', plugin_dir_path( __FILE__ ) );
// phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedConstantFound -- Plugin constants are acceptable without prefix.
define( 'OMS_PLUGIN_URL', plugin_dir_url( __FILE__ ) );
// phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedConstantFound -- Plugin constants are acceptable without prefix.
define( 'OMS_PLUGIN_BASENAME', plugin_basename( __FILE__ ) );
// phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedConstantFound -- Plugin constants are acceptable without prefix.
define( 'OMS_NOTIFY_ADMIN', true );

// Load required files.
require_once OMS_PLUGIN_DIR . 'includes/class-oms-exception.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-error-handler.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-config.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-cache.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-rate-limiter.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-logger.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-utils.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-filesystem.php';
require_once OMS_PLUGIN_DIR . 'includes/class-file-security-policy.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-database-cleaner.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-database-scanner.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-core-integrity-checker.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-quarantine-manager.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-api.php';
require_once OMS_PLUGIN_DIR . 'includes/class-obfuscated-malware-scanner.php';
require_once OMS_PLUGIN_DIR . 'includes/class-oms-plugin.php';
require_once OMS_PLUGIN_DIR . 'admin/class-oms-admin.php';

/**
 * Begin execution of the plugin.
 *
 * @phpcs:ignore WordPress.NamingConventions.PrefixAllGlobals.NonPrefixedFunctionFound -- Main plugin loader function.
 */
function run_obfuscated_malware_scanner() {
	// Initialize the plugin core.
	$plugin = OMS_Plugin::get_instance();
	$plugin->init();

	// Register activation and deactivation hooks.
	register_activation_hook( __FILE__, array( $plugin, 'activate' ) );
	register_deactivation_hook( __FILE__, array( $plugin, 'deactivate' ) );

	// Initialize admin functionality if in admin area.
	if ( is_admin() ) {
		$admin = new OMS_Admin( 'obfuscated-malware-scanner', OMS_VERSION );

		// Register settings.
		add_action( 'admin_init', array( $admin, 'register_settings' ) );

		// Add admin hooks.
		add_action( 'admin_enqueue_scripts', array( $admin, 'enqueue_styles' ) );
		add_action( 'admin_enqueue_scripts', array( $admin, 'enqueue_scripts' ) );
		add_action( 'admin_menu', array( $admin, 'add_options_page' ) );

		// Handle manual scan action.
		if ( isset( $_POST['oms_manual_scan'] ) && isset( $_POST['_wpnonce'] ) ) {
			// Verify nonce before adding action.
			$nonce = isset( $_POST['_wpnonce'] ) && is_string( $_POST['_wpnonce'] ) ? sanitize_text_field( wp_unslash( $_POST['_wpnonce'] ) ) : '';
			if ( ! empty( $nonce ) && wp_verify_nonce( $nonce, 'oms_manual_scan' ) ) {
				add_action( 'admin_init', array( $admin, 'handle_manual_scan' ) );
			}
		}
	}
}

run_obfuscated_malware_scanner();
