<?xml version="1.0"?>
<ruleset name="My Project">
    <description>WordPress Coding Standards for Obfuscated Malware Scanner</description>
    <file>includes/</file>
    <file>admin/</file>
    <file>obfuscated-malware-scanner.php</file>
    <file>tests/</file>
    <exclude-pattern>vendor/*</exclude-pattern>
    <exclude-pattern>wordpress/*</exclude-pattern>
    <exclude-pattern>.github/*</exclude-pattern>
    <exclude-pattern>src/*</exclude-pattern>
    <!-- PHP version for compatibility checks -->
    <config name="testVersion" value="8.4-"/>

    <!-- Minimum WordPress version for deprecated function checks -->
    <config name="minimum_wp_version" value="6.5"/>

    <!-- Use WordPress Coding Standards (NOT PSR-12) -->
    <rule ref="WordPress"/>

    <!--
        Array Syntax Decision:
        WPCS traditionally requires array() but many modern WP plugins allow [].
        For PHP 8.4 projects, short array syntax is acceptable.
        Choose ONE approach and be consistent:
        - Option A: Allow [] (modern PHP) - uncomment below
        - Option B: Require array() (traditional WPCS) - leave commented
        
        Currently: ALLOWING short array syntax for PHP 8.4 compatibility
    -->
    <rule ref="Generic.Arrays.DisallowShortArraySyntax">
        <severity>0</severity>
    </rule>

    <!-- PHP 8.4: declare(strict_types=1) must come before docblock, exclude this false positive -->
    <rule ref="Squiz.Commenting.FileComment.WrongStyle">
        <severity>0</severity>
    </rule>

    <!-- Allow file docblock after declare(strict_types=1) - required for PHP 8.4 strict mode -->
    <rule ref="Squiz.Commenting.FileComment.Missing">
        <exclude-pattern>includes/*</exclude-pattern>
        <exclude-pattern>admin/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.FileComment.SpacingAfterOpen">
        <severity>0</severity>
    </rule>

    <!-- PHP 8.4 with declare(strict_types=1): docblock must come after declare, exclude false positive -->
    <rule ref="Squiz.Commenting.FileComment.MissingPackageTag">
        <severity>0</severity>
    </rule>

    <!-- Universal.CodeAnalysis doesn't understand PHP 8.4 declare placement -->
    <rule ref="Universal.Files.SeparateFunctionsFromOO.Mixed">
        <exclude-pattern>includes/*</exclude-pattern>
    </rule>

    <!-- PHP 8.4: declare(strict_types=1) must come first, docblock follows - exclude PSR12 false positive -->
    <rule ref="PSR12.Files.FileHeader.IncorrectOrder">
        <severity>0</severity>
    </rule>

    <!-- PHP 8.4: Allow short ternary operator (?:) for null coalescing patterns -->
    <rule ref="Universal.Operators.DisallowShortTernary.Found">
        <severity>0</severity>
    </rule>

    <!-- WordPress 6.2+ uses %i placeholder for identifiers - PHPCS doesn't recognize this yet -->
    <rule ref="WordPress.DB.PreparedSQL.InterpolatedNotPrepared">
        <exclude-pattern>includes/class-oms-database-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-database-cleaner.php</exclude-pattern>
    </rule>
    <rule ref="WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare">
        <exclude-pattern>includes/class-oms-database-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-database-cleaner.php</exclude-pattern>
    </rule>
    <rule ref="WordPress.DB.PreparedSQL.NotPrepared">
        <exclude-pattern>includes/class-oms-database-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-database-cleaner.php</exclude-pattern>
    </rule>
    <!-- Allow class-file-security-policy.php naming (legacy compatibility) -->
    <rule ref="WordPress.Files.FileName">
        <exclude name="WordPress.Files.FileName.InvalidClassFileName"/>
    </rule>
    <!-- Allow direct FS operations only in scanner/logger where necessary -->
    <rule ref="WordPress.WP.AlternativeFunctions">
        <exclude-pattern>includes/class-obfuscated-malware-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-logger.php</exclude-pattern>
		<exclude-pattern>includes/class-oms-file-security-policy.php</exclude-pattern>
    </rule>
    <!-- Allow development functions only in scanner/logger -->
    <rule ref="WordPress.PHP.DevelopmentFunctions">
        <exclude-pattern>includes/class-obfuscated-malware-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-logger.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-exception.php</exclude-pattern>
        <exclude-pattern>tests/TestHelperTrait.php</exclude-pattern>
    </rule>
    <!-- file_get_contents used for local file reading in scanner context -->
    <rule ref="WordPress.WP.AlternativeFunctions.file_get_contents_file_get_contents">
        <exclude-pattern>includes/class-oms-utils.php</exclude-pattern>
        <exclude-pattern>includes/class-file-security-policy.php</exclude-pattern>
        <exclude-pattern>includes/class-obfuscated-malware-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-filesystem.php</exclude-pattern>
    </rule>
    <!-- ini_set used for security hardening in scanner -->
    <rule ref="WordPress.PHP.IniSet.Risky">
        <exclude-pattern>includes/class-obfuscated-malware-scanner.php</exclude-pattern>
    </rule>
    <!-- Direct DB queries for logging are acceptable -->
    <rule ref="WordPress.DB.DirectDatabaseQuery">
        <exclude-pattern>includes/class-oms-logger.php</exclude-pattern>
    </rule>
    <!-- Error suppression needed for regex validation -->
    <rule ref="WordPress.PHP.NoSilencedErrors">
        <exclude-pattern>includes/class-obfuscated-malware-scanner.php</exclude-pattern>
        <exclude-pattern>includes/class-oms-scanner.php</exclude-pattern>
    </rule>

    <!-- Test files follow PHPUnit conventions, not WordPress conventions -->
    <!-- Allow CamelCase filenames for PHPUnit test classes -->
    <rule ref="WordPress.Files.FileName.NotHyphenatedLowercase">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow camelCase method names for PHPUnit tests -->
    <rule ref="WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Test mocks may have unused parameters -->
    <rule ref="Generic.CodeAnalysis.UnusedFunctionParameter">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Test files don't need full doc comments -->
    <rule ref="Squiz.Commenting.FileComment.Missing">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.FunctionComment.Missing">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.VariableComment.Missing">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.ClassComment.Missing">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow direct file operations in tests for setup/teardown -->
    <rule ref="WordPress.WP.AlternativeFunctions">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow date() in test mocks -->
    <rule ref="WordPress.DateTime.RestrictedFunctions.date_date">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Inline comment punctuation not required in tests -->
    <rule ref="Squiz.Commenting.InlineComment.InvalidEndChar">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow camelCase variables in tests (PHPUnit convention) -->
    <rule ref="WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="WordPress.NamingConventions.ValidVariableName.PropertyNotSnakeCase">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow reserved keywords as parameter names in mock functions -->
    <rule ref="Universal.NamingConventions.NoReservedKeywordParameterNames">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Tests don't need output escaping -->
    <rule ref="WordPress.Security.EscapeOutput">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Tests don't need strict doc comment formatting -->
    <rule ref="Squiz.Commenting.FunctionComment.MissingParamComment">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.FunctionComment.ParamCommentFullStop">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.FunctionComment.ThrowsNoFullStop">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Squiz.Commenting.FunctionComment.EmptyThrows">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <rule ref="Generic.Commenting.DocComment.MissingShort">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Allow // style class comments in Codeception support files -->
    <rule ref="Squiz.Commenting.ClassComment.WrongStyle">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Multiple classes allowed in test files -->
    <rule ref="Generic.Files.OneObjectStructurePerFile">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Override detection not needed in tests -->
    <rule ref="Generic.CodeAnalysis.UselessOverridingMethod">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Mock classes may need to match external naming conventions (e.g., wpdb) -->
    <rule ref="PEAR.NamingConventions.ValidClassName.StartWithCapital">
        <exclude-pattern>tests/mocks/*</exclude-pattern>
    </rule>
    <!-- Mock files may mix functions and classes intentionally -->
    <rule ref="Universal.Files.SeparateFunctionsFromOO">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Tests may redefine classes for mocking purposes -->
    <rule ref="Generic.Classes.DuplicateClassName">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
    <!-- Tests intentionally override WordPress globals for mocking -->
    <rule ref="WordPress.WP.GlobalVariablesOverride.Prohibited">
        <exclude-pattern>tests/*</exclude-pattern>
    </rule>
</ruleset>
